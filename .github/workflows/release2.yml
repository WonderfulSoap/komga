name: Release  
  
on:  
  workflow_dispatch:  
    inputs:  
      version:  
        description: 'Version to release (e.g., v1.2.3 or 1.2.3)'  
        type: string  
        required: true  
      release_notes:  
        description: Release notes (use \n for newlines)  
        type: string  
        required: false  
      github_release:  
        description: 'Create Github Release'  
        default: true  
        type: boolean  
      docker_release:  
        description: 'Push Docker images'  
        default: true  
        type: boolean  
  
jobs:  
  version:  
    runs-on: ubuntu-latest  
    outputs:  
      version_current: ${{ steps.versions.outputs.version_current }}  
      version_next: ${{ steps.versions.outputs.version_next }}  
      should_release: ${{ steps.versions.outputs.should_release }}  
    steps:  
      - uses: actions/checkout@v6  
        with:  
          fetch-depth: 0  
          
      - name: Validate and normalize version  
        id: normalize_version  
        run: |  
          VERSION="${{ inputs.version }}"  
          # Remove 'v' prefix if present  
          VERSION=${VERSION#v}  
          # Validate version format (basic semver check)  
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]]; then  
            echo "Error: Invalid version format. Expected format: x.y.z or vx.y.z"  
            exit 1  
          fi  
          echo "normalized_version=$VERSION" >> $GITHUB_OUTPUT  
          echo "tag_version=v$VERSION" >> $GITHUB_OUTPUT  
          
      - name: Get current version  
        id: current_version  
        run: |  
          # Get current version from git tags  
          CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")  
          CURRENT_VERSION=${CURRENT_VERSION#v}  
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT  
          
      - name: Set Versions  
        id: versions  
        run: |  
          echo "version_current=${{ steps.current_version.outputs.current_version }}" >> $GITHUB_OUTPUT  
          echo "version_next=${{ steps.normalize_version.outputs.normalized_version }}" >> $GITHUB_OUTPUT  
          # Always allow release with manual version input  
          echo "should_release=true" >> $GITHUB_OUTPUT  
  
  release:  
    name: Release  
    runs-on: ubuntu-latest  
    needs: version  
    steps:  
      - name: Remove unnecessary files  
        run: |  
          sudo rm -rf /usr/share/dotnet  
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"  
  
      - uses: actions/checkout@v6  
        with:  
          fetch-depth: 0  
  
      - name: Display versions  
        run: |  
          echo "Current version: ${{ needs.version.outputs.version_current }}"  
          echo "Release version: ${{ needs.version.outputs.version_next }}"  
          echo "Should release: ${{ needs.version.outputs.should_release }}"  
  
      - name: Update version in gradle.properties  
        if: needs.version.outputs.should_release  
        run: sed -i -e "s/version=.*/version=${{ needs.version.outputs.version_next }}/" gradle.properties  
  
      - uses: actions/setup-node@v6  
        with:  
          node-version-file: '.nvmrc'  
          cache: 'npm'  
          cache-dependency-path: komga-webui/package-lock.json  
  
      - name: Setup Java 21  
        uses: actions/setup-java@v5  
        with:  
          java-version: 21  
          java-package: 'jdk'  
          distribution: 'temurin'  
  
      - name: Set up QEMU  
        uses: docker/setup-qemu-action@v3  
  
      - name: Set up Docker Buildx  
        uses: docker/setup-buildx-action@v3  
  
      - name: Login to Docker Hub  
        if: inputs.docker_release  
        uses: docker/login-action@v3  
        with:  
          username: ${{ secrets.DOCKER_USERNAME }}  
          password: ${{ secrets.DOCKER_PASSWORD }}  
  
      - name: Login to GitHub Container Registry  
        if: inputs.docker_release  
        uses: docker/login-action@v3  
        with:  
          registry: ghcr.io  
          username: ${{ github.repository_owner }}  
          password: ${{ secrets.GITHUB_TOKEN }}  
  
      - name: Setup Gradle  
        uses: gradle/actions/setup-gradle@v5  
  
      - name: Build  
        run: ./gradlew :komga:prepareThymeLeaf :komga:bootJar :komga-tray:jar  
        env:  
          NODE_OPTIONS: "--max-old-space-size=4096"  
  
      - name: Generate OpenAPI docs  
        if: needs.version.outputs.should_release  
        run: ./gradlew :komga:generateOpenApiDocs  
  
      - name: Create release notes  
        run: |  
          mkdir -p release_notes  
          echo -e "${{ inputs.release_notes }}" >> release_notes/release_notes.md  
          echo "Release notes:"  
          cat release_notes/release_notes.md  
          echo ""  
  
      - name: JReleaser Changelog append  
        if: needs.version.outputs.should_release  
        run: ./gradlew jreleaserChangelog  
        env:  
          JRELEASER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
          
      - name: JReleaser Changelog output  
        if: always() && needs.version.outputs.should_release  
        uses: actions/upload-artifact@v5  
        with:  
          name: jreleaser-changelog  
          path: |  
            build/jreleaser/trace.log  
            build/jreleaser/output.properties  
  
      # - name: Release commit and push  
      #   uses: EndBug/add-and-commit@v9  
      #   if: needs.version.outputs.should_release  
      #   with:  
      #     message: 'chore(release): v${{ needs.version.outputs.version_next }} [skip ci]'  
      #     tag: 'v${{ needs.version.outputs.version_next }}'  
      #     default_author: github_actions  
  
      - name: JReleaser Release  
        if: inputs.github_release  
        run: ./gradlew jreleaserRelease  
        env:  
          JRELEASER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
          
      - name: JReleaser Release output  
        if: always() && inputs.github_release  
        uses: actions/upload-artifact@v5  
        with:  
          name: jreleaser-release  
          path: |  
            build/jreleaser/trace.log  
            build/jreleaser/output.properties  
  
      - name: JReleaser Publish (Docker)  
        if: inputs.docker_release  
        run: ./gradlew jreleaserPublish -PdockerUser=wondersoap
        env:  
          JRELEASER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
          
      - name: JReleaser Publish output  
        if: always() && inputs.docker_release  
        uses: actions/upload-artifact@v5  
        with:  
          name: jreleaser-publish  
          path: |  
            build/jreleaser/trace.log  
            build/jreleaser/output.properties
